version: '3.8'

services:
  toughradius:
    build:
      context: .
      dockerfile: Dockerfile
    image: toughradius:latest
    container_name: toughradius
    restart: unless-stopped
    ports:
      - "1816:1816/tcp"
      - "51812:1812/udp"
      - "51813:1813/udp"
      - "2083:2083/tcp"
    environment:
      - TOUGHRADIUS_SYSTEM_WORKER_DIR=/data
      - TOUGHRADIUS_SYSTEM_DEBUG=true
      - TOUGHRADIUS_WEB_HOST=0.0.0.0
      - TOUGHRADIUS_WEB_PORT=1816
      - TOUGHRADIUS_WEB_SECRET=9b6de5cc-0731-1203-xxtt-0f568ac9da37
      - TOUGHRADIUS_DB_TYPE=postgres
      - TOUGHRADIUS_DB_HOST=db
      - TOUGHRADIUS_DB_PORT=5432
      - TOUGHRADIUS_DB_NAME=toughradius
      - TOUGHRADIUS_DB_USER=postgres
      - TOUGHRADIUS_DB_PWD=mypassword
      - TOUGHRADIUS_DB_DEBUG=false
      - TOUGHRADIUS_RADIUS_ENABLED=true
      - TOUGHRADIUS_RADIUS_HOST=0.0.0.0
      - TOUGHRADIUS_RADIUS_AUTHPORT=1812
      - TOUGHRADIUS_RADIUS_ACCTPORT=1813
      - TOUGHRADIUS_RADIUS_RADSEC_PORT=0
      - TOUGHRADIUS_RADIUS_DEBUG=true
      - TOUGHRADIUS_LOGGER_MODE=development
      - TOUGHRADIUS_LOGGER_FILE_ENABLE=true
      - INIT_DB=true
      - CONFIG_FILE=/etc/toughradius.yml
    volumes:
      - toughradius_data:/data
    depends_on:
      db:
        condition: service_healthy
    networks:
      xsp-net-31:
        ipv4_address: 172.31.0.20

  db:
    image: postgres:15-alpine
    container_name: toughradius-db
    restart: always
    environment:
      - POSTGRES_DB=toughradius
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=mypassword
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
       - "15432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      xsp-net-31:
        ipv4_address: 172.31.0.21

volumes:
  postgres_data:
  toughradius_data:

networks:
  xsp-net-31:
    external: true
